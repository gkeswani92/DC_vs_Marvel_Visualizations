<!DOCTYPE html>
<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="tip.js"></script>
    <script src="movieData.js"></script>
    <link href='style.css' rel='stylesheet' type='text/css'>
  </head>

  <body>
    <h2>D3 Scatterplot </h2>
    <p>This is a data visualization using transitions with a scatterplot</p>
    <h4>Click on this text to update chart with new values</h4>
    <h3 id = "xScales">Select X Scale<h3>
    <h3 id = "yScales">Select Y Scale<h3>
    <h3 id = "Scatter"></h3>

  <!-- Begin D3 Javascript -->
  <script type="text/javascript">

    //X scale buttons
    var xbuttonNames = ["Year Released", "Rotten Tomatoes Score", "Budget"]
    var xbuttons =["xRelease", "xTomato", "xBudget"]

    //Y scale buttons
    var ybuttonNames = ["Rotten Tomatoes Score", "Budget", "Sales"]
    var ybuttons =["yTomato", "yBudget", "ySales"]

    //Initial x,y categories
    var xselection = "RELEASE"
    var yselection = "ADJUSTED"

    //Min and Max for x domain
    var Minx;
    var Maxx;

    //Min and Max for y domain
    var Miny;
    var Maxy;
    var minRelease = Number.MAX_SAFE_INTEGER;
    var maxRelease = 0;
    var minAdjusted = Number.MAX_SAFE_INTEGER;
    var maxAdjusted = 0;
    var minBudget = Number.MAX_SAFE_INTEGER;
    var maxBudget = 0;
    var minTomato = Number.MAX_SAFE_INTEGER;
    var maxTomato = 0;

    var SetMinMax = function(MovieJSON){
        var R;
        var A;
        var B;
        var T;
        for(var i = 0; i< MovieJSON.length;i++){
            R = Number(MovieJSON[i].RELEASE);
            if (R < minRelease){
                minRelease = R;
            }
            if (R > maxRelease) {
                maxRelease = R;
            }

            A = Number(MovieJSON[i].ADJUSTED);
            if (A < minAdjusted){
                minAdjusted = A;
            }
            if (A > maxAdjusted) {
                maxAdjusted = A;
            }

            B = Number(MovieJSON[i].BUDGET);
            if (B < minBudget){
                minBudget = B;
            }
            if (B > maxBudget) {
                maxBudget = B;
            }

            T = Number(MovieJSON[i].Rotten_Tomatoes);
            if (T < minTomato){
                minTomato = T;
            }
            if (T > maxTomato) {
                maxTomato = T;
        }}};
    SetMinMax(MovieJSON);

    //Loads the data from the json object
    var LoadData = function(s1, s2) {
        //empty MoviePoints array
        var MoviePoints = [];
        for (var i = 0; i<MovieJSON.length;i++){
            var obj = MovieJSON[i];
            MoviePoints.push([obj.FILM, obj.COMPANY, obj[s1], obj[s2]])
        }
        return MoviePoints;
    }

    //Updates the x axis with depending on the selected button
    var updatex = function(d){
        console.log(d.id)
        if(d.id == "xRelease"){
            console.log("releasex");
            xselection = "RELEASE";
            Minx = minRelease;
            Maxx = maxRelease;
    }
        else if (d.id== "xTomato"){
            console.log("Tomatox");
            xselection = "Rotten_Tomatoes";
            Minx = minTomato;
            Maxx = maxTomato;}
        else {
            xselection= "BUDGET";
            Minx = minBudget;
            Maxx = maxBudget;}

        MoviePoints = LoadData(xselection,yselection);
        update(MoviePoints)
    }

    //Updates the y axis with depending on the selected button
    var updatey = function(d){

        if(d.id == "yBudget"){
            yselection = "BUDGET";
            Miny = minBudget;
            Maxy = maxBudget;
        }
        else if (d.id == "ySales"){
            yselection = "ADJUSTED";
            Miny = minAdjusted;
            Maxy = maxAdjusted;}
        else {
            yselection= "Rotten_Tomatoes";
            Miny = minTomato;
            Maxy = maxTomato;}
        MoviePoints = LoadData(xselection,yselection);
        update(MoviePoints);
    }

    //Create x axis Buttons
    d3.select("#xScales")
        .selectAll("input")
        .data(xbuttonNames)
        .enter().append("input")
        .attr("type","button")
        .attr("class","xbutton")
        .attr("value", function (d){return d;} );

    //Create unique id's
    d3.selectAll(".xbutton")[0]
        .forEach(function(d,i){
            d.setAttribute("id",xbuttons[i])});

    //update chart on click
    d3.select("#xRelease").on("click", function(d){updatex(this)});
    d3.select("#xTomato").on("click", function(d){updatex(this)});
    d3.select("#xBudget").on("click", function(d){updatex(this)});


    d3.select("#yScales")
        .selectAll("input")
        .data(ybuttonNames)
        .enter().append("input")
        .attr("type","button")
        .attr("class","ybutton")
        .attr("value", function (d){return d;} );

    d3.selectAll(".ybutton")[0]
        .forEach(function(d,i){
            d.setAttribute("id",ybuttons[i])});

    d3.select("#yTomato").on("click", function(d){updatey(this)});
    d3.select("#yBudget").on("click", function(d){updatey(this)});
    d3.select("#ySales").on("click", function(d){updatey(this)});


    //Have an x scale and y scale been chosen?
    MoviePoints = LoadData(xselection,yselection);

    //Get min year test
    var minyear = Math.min.apply(Math,MovieJSON.map(function(o){return o.RELEASE;}))
    var maxyear = Math.max.apply(Math,MovieJSON.map(function(o){return o.RELEASE;}))


    // Setup settings for graphic
    var canvas_width = 800;
    var canvas_height = 500;
    var padding = 100;  // for chart edges


    // Create scale functions for RELEASE year
    var xScale = d3.scale.linear()  // xScale is width of graphic
                    .domain([minyear,maxyear])
                    .range([padding, canvas_width - padding * 2]); // output range

    var yScale = d3.scale.linear()  // yScale is height of graphic
                    .domain([0, maxAdjusted])
                    .range([canvas_height - padding, padding]);  // remember y starts on top going down so we flip

    // Define X axis
    var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .ticks(5);

    // Define Y axis
    var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .ticks(5);

    // Create SVG element
    var svg = d3.select("#Scatter")  // This is where we put our vis
        .append("svg")
        .attr("width", canvas_width)
        .attr("height", canvas_height)

    //Creating a custom tip element for the hovering on the bubbles
    var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function(d) {
        return "<strong>Movie Name:</strong> <span style='color:red'>" + d[0] + " </span> <br/>"
            +  "<strong>Franchise:</strong> <span style='color:red'>" + d[1] + " </span> <br/>"
            +  "<strong>Release Year:</strong> <span style='color:red'>" + d[2] + " </span> <br/>"
            +  "<strong>Sales:</strong> <span style='color:red'>" + d[3] + " </span> <br/>";
      })
      svg.call(tip);

    // Create Circles
    svg.selectAll("circle")
        .data(MoviePoints)
        .enter()
        .append("circle")  // Add circle svg
        .attr("cx", function(d) {
            return xScale(d[2]);  // Circle's X
        })
        .attr("cy", function(d) {  // Circle's Y
            return yScale(d[3]);
        })
        .attr("r", 3) //TODO: Needs to dynamically done
        .on('mouseover', tip.show)
        .on('mouseout', tip.hide);

    // Add to X axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (canvas_height - padding) +")")
        .call(xAxis);

    // Add to Y axis
    svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + padding +",0)")
        .call(yAxis);

    // On click, update with new data
    var update = function(movies){

        // Update scale domains
        xScale.domain([Minx,Maxx]);
        yScale.domain([Miny, Maxy]);

        // Update circles
        svg.selectAll("circle")
            .data(MoviePoints)  // Update with new data
            .transition()  // Transition from old to new
            .duration(1000)  // Length of animation
            .each("start", function() {  // Start animation
                d3.select(this)  // 'this' means the current element
                    .attr("fill", "red")  // Change color
                    .attr("r", 5);  // Change size
            })
            .delay(function(d, i) {
                return i / movies.length * 500;  // Dynamic delay (i.e. each item delays a little longer)
            })
            .ease("linear")  // Transition easing - default 'variable' (i.e. has acceleration), also: 'circle', 'elastic', 'bounce', 'linear'
            .attr("cx", function(d) {
                return xScale(d[2]);  // Circle's X
            })
            .attr("cy", function(d) {
                return yScale(d[3]);  // Circle's Y
            })
            .each("end", function() {  // End animation
                d3.select(this)  // 'this' means the current element
                    .transition()
                    .duration(500)
                    .attr("fill", "black")  // Change color
                    .attr("r", 2);  // Change radius
            });

            // Update X Axis
            svg.select(".x.axis")
                .transition()
                .duration(1000)
                .call(xAxis);

            // Update Y Axis
            svg.select(".y.axis")
                .transition()
                .duration(100)
                .call(yAxis);
    };
    </script>
  </body>
</html>
